<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Centro de U√±as Sheila</title>
<script src="https://cdn.tailwindcss.com"></script>
<!-- Estilos-rosa.css eliminado -->
</head>
<body class="bg-gray-100 text-gray-900 min-h-screen flex items-center justify-center px-4">

<div class="text-center text-gray-900 w-full max-w-md p-6 bg-white rounded-2xl shadow-lg border border-blue-200">
    <h1 id="business-name" class="text-3xl tracking-wide mb-2 font-bold text-blue-600">üíÖ Cargando...</h1>
    <p id="business-welcome" class="text-lg font-semibold text-gray-700">¬°Bienvenida, tu belleza es nuestra pasi√≥n!</p>

    <div id="business-status-container" class="mb-4">
        <!-- Status will be injected here by JS -->
    </div>

    <p class="text-sm text-gray-500 mb-8" id="fecha-de-hoy"></p>

    <div class="bg-blue-100 text-gray-900 p-6 rounded-xl mb-6 shadow-inner border border-blue-200">
        <div class="text-4xl font-bold text-blue-600" id="turno-actual">--</div>
        <div class="text-sm mt-2 font-medium">TURNO ACTUAL</div>
        <div class="text-lg font-semibold mt-4"><span id="conteo-turno">0</span> EN ESPERA</div>
        <div class="text-sm mt-2 text-gray-600">Tiempo promedio de espera: <span id="tiempo-promedio" data-waiting-time="average">--</span></div>
    </div>

    <!-- Bot√≥n para abrir modal -->
    <button id="btn-tomar-turno" onclick="document.getElementById('modal').classList.remove('hidden')"
    class="bg-blue-500 hover:bg-blue-600 transition w-full py-3 text-white font-semibold rounded-xl shadow disabled:bg-gray-400 disabled:cursor-not-allowed">
    ‚ú® TOMAR TURNO
    </button>

    <!-- Contenedor del mensaje de confirmaci√≥n -->
    <div id="mensaje-turno" class="mt-6"></div>

    <!-- Historial de clientes (oculto por defecto) -->
    <div id="client-history" class="mt-6 bg-white p-4 rounded-xl shadow hidden">
        <h3 class="text-lg font-semibold text-blue-600 mb-2">Historial de Clientes</h3>
        <div id="client-history-content" class="text-sm"></div>
    </div>

    <!-- Modal -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden px-4">
        <div class="bg-white text-gray-900 rounded-2xl w-full max-w-2xl p-6 relative shadow-2xl border border-blue-200">
            <button onclick="document.getElementById('modal').classList.add('hidden')"
            class="absolute top-4 right-4 text-gray-500 text-2xl font-bold hover:text-blue-600">&times;</button>

            <h2 class="text-xl font-bold mb-4 text-blue-600">Reservar tu turno</h2>
            <form id="formRegistroNegocio" class="space-y-4">
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Nombre</label>
                        <input type="text" name="nombre" required class="w-full border border-blue-300 rounded-lg p-2 focus:ring-blue-400 focus:border-blue-400" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Tel√©fono</label>
                        <input type="tel" name="telefono" required class="w-full border border-blue-300 rounded-lg p-2 focus:ring-blue-400 focus:border-blue-400" />
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium mb-1">Servicio</label>
                        <select name="tipo" required class="w-full border border-blue-300 rounded-lg p-2 focus:ring-blue-400 focus:border-blue-400">
                            <option value="">Selecciona servicio</option>
                            <!-- Los servicios se cargar√°n din√°micamente desde services.js -->
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium mb-1">Notas / Detalles</label>
                        <textarea name="descripcion" rows="3"
                        class="w-full border border-blue-300 rounded-lg p-2 focus:ring-blue-400 focus:border-blue-400"></textarea>
                    </div>
                </div>
                <div class="flex justify-between items-center pt-4">
                    <span id="estadoRegistro" class="text-green-600 text-sm"></span>
                    <button type="submit"
                    class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition">
                    Confirmar Turno
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="admin/formulariocliente.js"></script>
<script src="admin/services.js"></script>
<script>
(function(){
  const elFecha = document.getElementById('fecha-de-hoy');
  const elActual = document.getElementById('turno-actual');
  const elEspera = document.getElementById('conteo-turno');
  const elMensaje = document.getElementById('mensaje-turno');
  const modal = document.getElementById('modal');
  const form = document.getElementById('formRegistroNegocio');
  const takeTurnButton = document.getElementById('btn-tomar-turno');

  function formatFecha() {
    try {
      const d = new Date();
      return d.toLocaleDateString('es-DO', { weekday:'long', year:'numeric', month:'long', day:'numeric' })
        + ' ' + d.toLocaleTimeString('es-DO', { hour: '2-digit', minute: '2-digit' });
    } catch(e) {
      return new Date().toLocaleString();
    }
  }

  function formatDuration(seconds) {
    if (seconds === null || seconds === undefined || seconds < 60) return 'menos de 1 min';
    const totalMinutes = Math.floor(seconds / 60);
    if (totalMinutes < 60) return `aprox. ${totalMinutes} min`;
    const hours = Math.floor(totalMinutes / 60);
    const minutes = totalMinutes % 60;
    return `aprox. ${hours}h ${minutes}min`;
  }

  function checkActiveTurn() {
    if (!window.TurnoRD) return; // Wait for TurnoRD to be initialized
    const activeTurnJSON = sessionStorage.getItem('activeClientTurn');
    if (!activeTurnJSON) {
      takeTurnButton.disabled = false;
      takeTurnButton.innerHTML = '‚ú® TOMAR TURNO';
      return;
    }

    const activeTurn = JSON.parse(activeTurnJSON);
    const state = TurnoRD.getState();
    const myTurn = state.queue.find(t => t.id === activeTurn.id);

    if (myTurn && (myTurn.status === 'waiting' || myTurn.status === 'serving')) {
      takeTurnButton.disabled = true;
      takeTurnButton.innerHTML = `YA TIENES EL TURNO <strong>${myTurn.code}</strong>`;
      const peopleAhead = state.queue.filter(t => t.status === 'waiting' && new Date(t.createdAt) < new Date(myTurn.createdAt)).length;
      elMensaje.innerHTML = `<div class="bg-blue-50 text-blue-700 px-4 py-3 rounded-lg">üëç Tienes el turno <strong>${myTurn.code}</strong>. Hay ${peopleAhead} persona${peopleAhead !== 1 ? 's' : ''} delante.</div>`;
    } else {
      sessionStorage.removeItem('activeClientTurn');
      takeTurnButton.disabled = false;
      takeTurnButton.innerHTML = '‚ú® TOMAR TURNO';
      if (elMensaje.innerHTML.includes(activeTurn.code)) {
        elMensaje.innerHTML = '';
      }
    }
  }

  function render(state){
    const cur = TurnoRD.getCurrentTicket();
    elActual.textContent = cur ? cur.code : '--';
    const waiting = state.queue.filter(t => t.status === 'waiting').length;
    elEspera.textContent = String(waiting);

    const tiempoPromedio = document.getElementById('tiempo-promedio');
    if (tiempoPromedio && window.ServicesManager) {
        const waitingTimes = ServicesManager.getWaitingTimes();
        const avgTime = waitingTimes.average ? waitingTimes.average.average : 0;
        tiempoPromedio.textContent = avgTime ? formatDuration(avgTime) : '--';
    }

    // Historial de clientes (sin cambios)
    const clientHistoryDiv = document.getElementById('client-history');
    const clientHistoryContent = document.getElementById('client-history-content');
    if (clientHistoryDiv && clientHistoryContent && window.ServicesManager && ServicesManager.getClientByPhone) {
      // Logic to show history based on phone number can remain if desired
    }

    checkActiveTurn();
  }

  elFecha.textContent = formatFecha();
  setInterval(() => { elFecha.textContent = formatFecha(); }, 60000);

  TurnoRD.subscribe(render);

  form.addEventListener('submit', function(e){
    e.preventDefault();
    const fd = new FormData(form);
    const nombre = fd.get('nombre') || '';
    const telefono = fd.get('telefono') || '';
    const tipo = fd.get('tipo') || '';
    const descripcion = fd.get('descripcion') || '';
    const { ticket, ahead } = TurnoRD.addTicket({ name: nombre, phone: telefono, type: tipo, description: descripcion });

    let estimatedWaitSeconds = 0;
    if (window.ServicesManager) {
        const services = ServicesManager.getServices().items;

        let totalDurationOfQueue = 0;
        const waitingQueue = TurnoRD.getState().queue.filter(t => t.status === 'waiting' && new Date(t.createdAt) < new Date(ticket.createdAt));

        waitingQueue.forEach(t => {
            const service = services.find(s => s.name === t.type);
            totalDurationOfQueue += service ? service.duration * 60 : (30*60); // default 30 mins
        });
        estimatedWaitSeconds = totalDurationOfQueue;
    }
    const waitTimeMessage = estimatedWaitSeconds > 0 ? `Tiempo de espera estimado: <strong>${formatDuration(estimatedWaitSeconds)}</strong>.` : 'Ser√°s atendido/a en breve.';

    elMensaje.innerHTML = `<div class="bg-blue-50 text-blue-700 px-4 py-3 rounded-lg">‚ú® Turno registrado: <strong>${ticket.code}</strong>. ${waitTimeMessage}</div>`;

    sessionStorage.setItem('activeClientTurn', JSON.stringify({ id: ticket.id, code: ticket.code }));

    modal.classList.add('hidden');
    form.reset();
    checkActiveTurn();
  });

  // Initial check once everything is loaded
  setTimeout(checkActiveTurn, 200);

  // --- Business Hours and Break Logic ---
  const urlParams = new URLSearchParams(window.location.search);
  const businessIdFromUrl = urlParams.get('business');

  function getBusinessId() {
    return businessIdFromUrl || 'default';
  }

  function getPrefixedKey(baseKey) {
    const businessId = getBusinessId();
    return `${businessId}_${baseKey}`;
  }

  function readJSON(key, fallback){ try{ const raw = localStorage.getItem(key); return raw? JSON.parse(raw) : fallback; }catch(_){ return fallback; } }
  function getConfig(){ return readJSON(getPrefixedKey('turnord_config_v1'), { hours: { open: '08:00', close: '20:00' }, openDays: [1,2,3,4,5,6] }); }
  function getBreakState(){ return readJSON(getPrefixedKey('turnord_break_v1'), { isOn:false, endAt:null, message:'' }); }

  function checkBusinessStatus() {
    const config = getConfig();
    const breakState = getBreakState();
    const now = new Date();
    const currentDay = now.getDay(); // 0=Sunday, 1=Monday, etc.
    const currentTime = now.getHours() * 60 + now.getMinutes();

    const openTime = (config.hours.open.split(':').map(Number)[0] * 60) + (config.hours.open.split(':').map(Number)[1]);
    const closeTime = (config.hours.close.split(':').map(Number)[0] * 60) + (config.hours.close.split(':').map(Number)[1]);

    const isOpenToday = config.openDays.includes(currentDay);
    const isWithinHours = currentTime >= openTime && currentTime < closeTime;
    const isOnBreak = breakState.isOn && new Date(breakState.endAt) > now;

    const statusContainer = document.getElementById('business-status-container');
    const takeTurnButton = document.getElementById('btn-tomar-turno');
    let statusMessage = '';
    let canTakeTurn = false;

    if (isOnBreak) {
      statusMessage = `<div class="bg-yellow-100 text-yellow-800 p-3 rounded-lg text-center">${breakState.message || 'En descanso, volvemos pronto.'}</div>`;
      canTakeTurn = false;
    } else if (!isOpenToday || !isWithinHours) {
      statusMessage = `<div class="bg-red-100 text-red-800 p-3 rounded-lg text-center"><strong>Cerrado Ahora.</strong> Horario: ${config.hours.open} - ${config.hours.close}</div>`;
      canTakeTurn = false;
    } else {
      statusMessage = `<div class="bg-green-100 text-green-800 p-3 rounded-lg text-center"><strong>Abierto Ahora.</strong> ¬°Te esperamos!</div>`;
      canTakeTurn = true;
    }

    statusContainer.innerHTML = statusMessage;
    // Only enable the button if the business is open AND the user doesn't have an active turn
    if (!canTakeTurn) {
        takeTurnButton.disabled = true;
    } else {
        checkActiveTurn(); // Let checkActiveTurn make the final decision
    }
  }

  // Also load business name
  function loadBusinessDetails() {
    const businessId = getBusinessId();
    if (window.APP_BUSINESSES) {
        const business = window.APP_BUSINESSES.find(b => b.id === businessId);
        if (business) {
            document.getElementById('business-name').textContent = `üíÖ ${business.name}`;
            document.title = business.name;
        } else {
            document.getElementById('business-name').textContent = 'Negocio no encontrado';
        }
    }
  }

  // Run checks
  if (businessIdFromUrl) {
    // Override TurnoRD's active business ID for this page
    sessionStorage.setItem('activeBusinessId', businessIdFromUrl);
    loadBusinessDetails();
    checkBusinessStatus();
    setInterval(checkBusinessStatus, 60000); // Check every minute
  } else {
    document.getElementById('business-status-container').innerHTML = '<div class="bg-red-100 text-red-800 p-3 rounded-lg text-center">Error: No se ha especificado un negocio.</div>';
    document.getElementById('btn-tomar-turno').disabled = true;
  }

})();
</script>

<!-- Script de configuraci√≥n -->
<script src="admin/configuracion.js"></script>
</body>
</html>
